name: Deploy Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 1.1.0)'
        required: true
        type: string

permissions:
  contents: write
  actions: read

env:
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  deploy-mac:
    name: Build & Deploy macOS
    runs-on: macos-latest
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases/tag/v${{ inputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ inputs.version }}
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: false

      - name: Verify release tag exists
        run: |
          git fetch --tags --depth=1
          if ! git rev-parse "v${{ inputs.version }}" >/dev/null 2>&1; then
            echo "❌ Release tag v${{ inputs.version }} not found!"
            echo "Available tags:"
            git tag | grep "^v" | sort -V | tail -10
            exit 1
          fi
          echo "✅ Release tag verified: v${{ inputs.version }}"

      - name: Checkout main for version bump
        uses: actions/checkout@v4
        with:
          ref: main
          path: repo-version

      - name: Update package.json version on main
        id: bump-version
        working-directory: repo-version
        env:
          VERSION: ${{ inputs.version }}
        run: |
          npm version "${VERSION}" --no-git-tag-version --allow-same-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          if git diff --staged --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "⚠️ Version already matches insights release, no commit created"
          else
            git commit -m "chore: bump version to v${VERSION}"
            git push origin main
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache whisper.cpp build
        id: cache-whisper
        uses: actions/cache@v4
        with:
          path: |
            whisper.cpp/build-arm64
            whisper.cpp/build-x86_64
            bin/whisper-cli
          key: whisper-cpp-universal-${{ runner.os }}-${{ hashFiles('scripts/setup-whisper-cpp.sh') }}
          restore-keys: |
            whisper-cpp-universal-${{ runner.os }}-

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: |
            .cache/electron
            .cache/electron-builder
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: electron-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            electron-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci --prefer-offline

      - name: Update package.json version
        run: |
          npm version ${{ inputs.version }} --no-git-tag-version --allow-same-version
          echo "✅ Updated package.json to version ${{ inputs.version }}"

      - name: Build whisper.cpp (universal binary)
        if: steps.cache-whisper.outputs.cache-hit != 'true'
        run: npm run setup:whisper:universal

      - name: Verify whisper-cli exists
        run: |
          if [ ! -f "bin/whisper-cli" ]; then
            echo "❌ whisper-cli not found, rebuilding..."
            npm run setup:whisper:universal
          else
            echo "✅ whisper-cli found"
            lipo -info bin/whisper-cli
          fi

      - name: Generate icons
        run: npm run icons

      - name: Build application
        run: npm run build

      - name: Build Electron app for macOS
        run: npx electron-builder --mac --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          USE_HARD_LINKS: false

      - name: Upload macOS artifacts to release
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload v${{ inputs.version }} \
            release/*.dmg \
            release/*.zip \
            release/*.blockmap \
            release/latest-mac.yml \
            --clobber

      - name: Deployment notification
        if: success()
        uses: actions/github-script@v7
        env:
          VERSION: ${{ inputs.version }}
        with:
          script: |
            const version = process.env.VERSION;
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `v${version}`,
                environment: 'production',
                description: `WhisperDesk v${version} deployed`,
                required_contexts: []
              });
              await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: deployment.data.id,
                state: 'success',
                environment_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/v${version}`,
                description: 'Build completed and uploaded to GitHub Release'
              });
            } catch (error) {
              console.error('Failed to create deployment:', error);
            }

  # Optional: Build for Windows (uncomment when ready)
  # deploy-windows:
  #   name: Build & Deploy Windows
  #   runs-on: windows-latest
  #   environment:
  #     name: production
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         ref: v${{ inputs.version }}
  #
  #     - name: Verify release tag exists
  #       run: |
  #         if (-not (git rev-parse "v${{ inputs.version }}" 2>$null)) {
  #           Write-Error "Release tag v${{ inputs.version }} not found!"
  #           exit 1
  #         }
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Build application
  #       run: npm run build
  #
  #     - name: Build Electron app for Windows
  #       run: npx electron-builder --win --publish never
  #       env:
  #         GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Upload Windows artifacts to release
  #       uses: softprops/action-gh-release@v2
  #       if: success()
  #       with:
  #         tag_name: v${{ inputs.version }}
  #         files: |
  #           release/*.exe
  #           release/*.blockmap
  #           release/latest.yml
  #         fail_on_unmatched_files: true
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
